#!/bin/env bash
trap sig_abort SIGINT
start=`date +%s`
ARGS='--connect-timeout 5 --max-time 10 --retry 5 --retry-delay 0 --retry-max-time 40 -ks'; SERVER="root"; LOCAL="persie"
DIR=~/.turbodl; PXLS=(480 720 1080 2160);
mkdir -p $DIR/movies $DIR/series $DIR/logs $DIR/junk; cd "$DIR"; JUNK=junk
find . ! -name '*list' ! -name 'md5' -type f -exec rm -rf {} +
if [ "$USER" == "$SERVER" ]; then cat ~/turbodl/list > $DIR/list; else cat ~/git/turbodl/list > $DIR/list; fi
printf %b ":: working...\\r"
case "$1" in
    '') exit;;
    -l|--lightdl)
        shift; echo -e "https://www.lightdl.xyz" > $JUNK/url
        for PARAM; do grep ^'%' <<< "$PARAM" | sed 's/%/^/' >> $JUNK/pattern; done;;
    -t|--twitchdl)
        shift; echo -e "https://dl.twitchdl.us" > $JUNK/url
        for PARAM; do grep ^'%' <<< "$PARAM" | sed 's/%/^/' >> $JUNK/pattern; done;;
    -u|--url)
        shift
        for PARAM; do grep 'http' <<< "$PARAM" >> $JUNK/url || grep ^'%' <<< "$PARAM" | sed 's/%/^/' >> $JUNK/pattern; done;;
    *)  exit;;
esac
(while IFS= read -r "U"; do
    curl $ARGS "$U" | grep -oE "https.*html.*(|title).*</a>" | sed 's:</a>:\n:g; /Releases/d; /Movies/d; /jpg/d; /Series/d; /List/d; /Read More/d; /GAME OF THRONES/d; /gfn/d; /COVID-19/d; / [0-9][0-9][0-9][0-9] /d' > "$JUNK/main" || exit
    sed '/search/d; /^$/d' $JUNK/main | grep -n . > $JUNK/mains; mv $JUNK/mains $JUNK/main
    if [ -e $JUNK/pattern ]; then
        output=$(grep -w -f $JUNK/pattern $JUNK/main | sed "s:.*>::; s: - SEASON.*::")
    else
        output=$(sed "s:.*>::; s: - SEASON.*::" "$JUNK/main")
    fi
    (while IFS= read -r "OUTPUT"; do
        FUNC &
        echo "$!" >> "$JUNK/pid"
        echo $! >> $JUNK/pids
    done <<< $output; exit) &
    echo "$!" >> "$JUNK/pid"
    echo $! >> $JUNK/pids
done < $JUNK/url; exit) &
echo "$!" >> "$JUNK/pid"
echo $! >> $JUNK/pids
while grep -owq -f "$JUNK/pid" <<< $(ls /proc); do printf %b ":: working...\\r"; sleep 5; done

#for series
#curl --connect-timeout 5 --max-time 10 --retry 5 --retry-delay 0 --retry-max-time 40 -s --header "Content-Type: application/json" 'https://eztv.io/api/get-torrents?imdb_id=6048596' | jq .
#for movies
#curl --connect-timeout 5 --max-time 10 --retry 5 --retry-delay 0 --retry-max-time 40 -s --header "Content-Type: application/json" 'https://yts.mx/api/v2/list_movies.json?query_term=tt1502397' | jq .
#magnet:?xt=urn:btih:
